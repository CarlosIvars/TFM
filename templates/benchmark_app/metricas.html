{% load static %}
{% load extras %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Métricas de Agentes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 1200px; }
    .header {
      background-image: linear-gradient(135deg, #0d6efd, #66b3ff83);
      color: white;
      padding: 30px;
      border-radius: 0.5rem;
      margin-bottom: 30px;
      text-align: center;
    }
    .panel { background: white; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.05); }
    .case-title { font-weight: 600; margin-bottom: .5rem; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg mb-4" style="background: linear-gradient(90deg, #0d6efd, #66b2ff); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div class="container d-flex justify-content-between align-items-center">
      <span class="navbar-brand text-white fw-semibold mb-0 h1">Benchmark de Agentes</span>
      <a href="/admin/login/?next=/admin/" class="btn btn-outline-light">Admin</a>
    </div>
  </nav>

  <div class="container">
    <div class="header">
      <h1 class="h3">Métricas de Agentes</h1>
      <p class="mb-0">Visión general del rendimiento y satisfacción de cada agente.</p>
    </div>

    <!-- Tabs de navegación -->
    <ul class="nav nav-tabs mb-4">
      <li class="nav-item">
        <a class="nav-link" href="/">Ejecutar Agente</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/resultados/">Evaluar Agente</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" aria-current="page" href="#">Métricas Agentes</a>
      </li>
    </ul>

    <!-- Desempeño por Categoría (promedio global) -->
    <h4 class="mb-3">Desempeño por Categoría</h4>
    <div class="panel p-3 mb-4">
      <canvas id="chartCategoria" width="600" height="300"></canvas>
    </div>

    <!-- Botonera de categorías -->
    <div class="mb-3">
      <div class="btn-group" role="group" aria-label="Categorías">
        {% for cat in categorias_data.categorias %}
          <button type="button"
                  class="btn btn-outline-primary category-btn {% if forloop.first %}active{% endif %}"
                  data-categoria="{{ cat }}">{{ cat }}</button>
        {% endfor %}
      </div>
    </div>

    <!-- NEW: Desempeño por agente y caso de uso (tablas por caso, eje X = pasos esperados/preguntas) -->
    {% for cat in categorias_data.categorias %}
      <div class="category-cases" data-categoria="{{ cat }}" style="{% if not forloop.first %}display:none;{% endif %}">
        <h5 class="mt-4 mb-2">Desempeño por agente y caso de uso ({{ cat }})</h5>

        {% with lista=case_steps_by_cat|get_item:cat %}
          {% if lista %}
            {% for c in lista %}
              <div class="panel p-3 mb-4">
                <div class="case-title">{{ c.caso_titulo }}</div>
                <small class="text-muted d-block mb-2">Porcentaje de pasos completados por pregunta (Humano vs LLM)</small>
                <canvas id="caseStepsChart_{{ c.caso_id }}" width="1200" height="360"></canvas>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-muted">No hay datos para esta categoría.</div>
          {% endif %}
        {% endwith %}
      </div>
    {% endfor %}

    <!-- Satisfacción global -->
    <h4 class="mt-5 mb-3">Satisfacción de Usuarios vs Evaluación LLM</h4>
    <div class="panel p-3 mb-4">
      <canvas id="chartSatisfaccion" width="600" height="300"></canvas>
    </div>

    <!-- Pros/Contras -->
    <h4 class="mt-5 mb-3">Pros y Contras por Agente</h4>
    {% for agent_name, pc in pros_cons.items %}
      <div class="mb-4">
        <h5 class="mb-2">{{ agent_name }}</h5>
        <div class="row">
          <div class="col-md-6">
            <strong>Pros:</strong>
            <ul class="ps-3">
              {% for pro in pc.pros %}
                <li>{{ pro }}</li>
              {% endfor %}
            </ul>
          </div>
          <div class="col-md-6">
            <strong>Contras:</strong>
            <ul class="ps-3">
              {% for con in pc.cons %}
                <li>{{ con }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Scripts de gráficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
  <script>
    // ===== Chart: Desempeño por Categoría =====
    new Chart(document.getElementById('chartCategoria').getContext('2d'), {
      type: 'bar',
      data: {
        labels: {{ categorias_data.labels_json|safe }},
        datasets: [
          {
            label: 'Humano',
            data: {{ categorias_data.hum_data_json|safe }},
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'LLM',
            data: {{ categorias_data.llm_data_json|safe }},
            backgroundColor: 'rgba(255, 159, 64, 0.7)',
            borderColor: 'rgba(255, 159, 64, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: { display: true, text: 'Desempeño promedio por Categoría' }
        },
        scales: {
          y: { beginAtZero: true, max: 100, title: { display: true, text: '% de pasos cumplidos' } },
          x: { title: { display: true, text: 'Categoría' }, ticks: { maxRotation: 45, minRotation: 45 } }
        }
      }
    });

    // Toggle de categorías (muestra/oculta los bloques por categoría)
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const cat = btn.dataset.categoria;
        document.querySelectorAll('.category-cases').forEach(div => {
          div.style.display = (div.dataset.categoria === cat) ? 'block' : 'none';
        });
      });
    });

    // ===== Chart: Satisfacción global (Usuarios vs LLM) =====
    (function() {
      const ctxSat = document.getElementById('chartSatisfaccion').getContext('2d');
      new Chart(ctxSat, {
        type: 'bar',
        data: {
          labels: {{ satisfaccion_data.labels_json|safe }},
          datasets: [
            {
              label: 'Valoración Usuarios',
              data: {{ satisfaccion_data.hum_data_json|safe }},
              backgroundColor: 'rgba(54, 162, 235, 0.7)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            },
            {
              label: 'Valoración LLM',
              data: {{ satisfaccion_data.llm_data_json|safe }},
              backgroundColor: 'rgba(255, 159, 64, 0.7)',
              borderColor: 'rgba(255, 159, 64, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Satisfacción Promedio por Agente (Usuarios vs LLM)'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 5,
              title: {
                display: true,
                text: 'Puntuación (1-5)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Agente'
              }
            }
          }
        }
      });
    })();

    // ===== Charts por Caso de Uso (por categoría) =====
    const caseStepsByCat = {{ case_steps_by_cat_json|safe }};
    for (const [cat, cases] of Object.entries(caseStepsByCat || {})) {
      (cases || []).forEach(c => {
        const el = document.getElementById(`caseStepsChart_${c.caso_id}`);
        if (!el) return;
        const ctx = el.getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: c.labels,
            datasets: [
              {
                label: 'Humano',
                data: c.hum,
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                stack: 'stack1'
              },
              {
                label: 'LLM',
                data: c.llm,
                backgroundColor: 'rgba(255, 159, 64, 0.7)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1,
                stack: 'stack1'
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Porcentaje de pasos completados por pregunta' },
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
              x: { stacked: true, ticks: { maxRotation: 40, minRotation: 0 } },
              y: { stacked: true, beginAtZero: true, max: 100, title: { display: true, text: '% completado' } }
            }
          }
        });
      });
    }
  </script>
</body>
</html>
