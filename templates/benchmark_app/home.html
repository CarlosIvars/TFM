<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Benchmark de Agentes Web</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 1200px; }
    .header {
      background-image: linear-gradient(135deg, #0d6efd, #66b3ff83);
      color: white;
      padding: 30px;
      border-radius: 0.5rem;
      margin-bottom: 30px;
      text-align: center;
    }
    .card { border: none; }
    textarea { resize: vertical; }
    select option { white-space: pre-wrap; }
    #promptPreview {
      white-space: pre-wrap;
      font-size: 0.875rem;
      background-color: #f1f1f1;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-4" style="background: linear-gradient(90deg, #0d6efd, #66b2ff); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div class="container d-flex justify-content-between align-items-center">
      <span class="navbar-brand text-white fw-semibold mb-0 h1">Benchmark de Agentes</span>
      <a href="/admin/login/?next=/admin/" class="btn btn-outline-light">Admin</a>
    </div>
  </nav>
  <div class="container">
    <div class="header">
      <h1 class="h3">Ejecución de Agentes de Web Scraping</h1>
      <p class="mb-0">Selecciona un caso, un agente, y ejecuta para obtener resultados automáticos.</p>
    </div>

    <!-- Barra de pestañas para navegar entre Ejecutar/Evaluar/Métricas -->
    <ul class="nav nav-tabs mb-4">
      <li class="nav-item">
        <a class="nav-link active" aria-current="page" href="#">Ejecutar Agente</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="evaluarAgenteLink" href="/resultados/">Evaluar Agente</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/metricas/">Métricas Agentes</a>
      </li>
    </ul>

    <div class="card shadow-sm p-4 mb-4 bg-white">
      <div class="mb-3">
        <label for="categoriaSelect" class="form-label">Categoría</label>
        <select class="form-select" id="categoriaSelect"></select>
      </div>
      <div class="mb-3">
        <label for="casoSelect" class="form-label">Caso de uso</label>
        <select class="form-select" id="casoSelect" disabled></select>
      </div>
      <div class="mb-3">
        <label for="preguntaSelect" class="form-label">Prompt disponible</label>
        <select class="form-select" id="preguntaSelect"></select>
        <div id="promptPreview" class="mt-2"></div>
        <button class="btn btn-outline-primary mt-2" onclick="abrirModalPrompt()">Crear nuevo prompt</button>
      </div>
      <div class="mb-3">
        <label for="agenteSelect" class="form-label">Agente</label>
        <select class="form-select" id="agenteSelect"></select>
      </div>
      <div class="mb-3 text-end">
        <button id="runBtn" class="btn btn-primary" onclick="runAgent()">Ejecutar Agente</button>
      </div>
    </div>

    <!-- MODAL: Crear nuevo prompt -->
    <div class="modal fade" id="nuevoPromptModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Nuevo Prompt Personalizado</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3" 
              id="contextoSeleccionado">
            </div>
            <div class="mb-3">
              <label for="customPrompt" class="form-label">Prompt personalizado</label>
              <textarea class="form-control" id="customPrompt" rows="3" placeholder="Escribe aquí tu prompt..."></textarea>
            </div>
            <div class="mb-3">
              <label for="tipoSelect" class="form-label">Tipo de tarea</label>
              <select id="tipoSelect" class="form-select">
                <option disabled selected value="">Seleccione un tipo</option>
                <option value="extraccion">Extracción</option>
                <option value="navegacion">Navegación</option>
                <option value="interaccion">Interacción</option>
                <option value="login">Login</option>
                <option value="simulacion_compra">Simulación de compra</option>
                <option value="visual">Visual</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Dificultad</label>
              <div class="btn-group w-100" role="group" id="dificultadToggle">
                <input type="radio" class="btn-check" name="dificultad" id="facil" value="facil" autocomplete="off" />
                <label class="btn btn-outline-primary" for="facil">Fácil</label>
                <input type="radio" class="btn-check" name="dificultad" id="media" value="media" autocomplete="off" />
                <label class="btn btn-outline-primary" for="media">Media</label>
                <input type="radio" class="btn-check" name="dificultad" id="dificil" value="dificil" autocomplete="off" />
                <label class="btn btn-outline-primary" for="dificil">Difícil</label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="savePrompt()">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal mientras ejecuta -->
    <div class="modal fade" id="runningModal" tabindex="-1"
          aria-labelledby="runningModalLabel" aria-hidden="true"
          data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">

            <div class="modal-header border-0">
              <h5 class="modal-title" id="runningModalLabel">Agente en ejecución…</h5>
              <!-- X para cerrar -->
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body d-flex align-items-center gap-3">
              <div class="spinner-border" role="status" aria-hidden="true"></div>
              <div>
                <p class="mb-1">En unos momentos se mostrará el resultado.</p>
                <small class="text-muted">Puedes cerrar esta ventana con la X y seguir navegando.</small>
              </div>
            </div>

          </div>
        </div>
      </div>


    <!-- Modal de confirmación al ejecutar agente -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Agente lanzado</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            El agente ha terminado la ejecución correctamente.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
          </div>
        </div>
      </div>
    </div>
  </div> <!-- /container -->

  <script>
    // ---------- Helpers de exclusividad ----------
    function setModePredef() {
      // Modo "Prompt disponible" seleccionado
      document.getElementById('customPrompt').value = '';
      document.getElementById('customPrompt').disabled = true;
      document.getElementById('tipoSelect').disabled = true;
      document.querySelectorAll('input[name="dificultad"]').forEach(r => r.disabled = true);
      const guardarBtn = document.getElementById('guardarBtn');
      if (guardarBtn) guardarBtn.disabled = true;
    }

    function setModeCustom() {
      // Modo "Prompt personalizado" activo
      const preguntaSelect = document.getElementById('preguntaSelect');
      // Resetea "Prompt disponible" a la opción por defecto
      if (preguntaSelect.options.length > 0) {
        preguntaSelect.selectedIndex = 0;
      }
      document.getElementById('promptPreview').textContent = '';
      document.getElementById('customPrompt').disabled = false;
      document.getElementById('tipoSelect').disabled = false;
      document.querySelectorAll('input[name="dificultad"]').forEach(r => r.disabled = false);
      const guardarBtn = document.getElementById('guardarBtn');
      if (guardarBtn) guardarBtn.disabled = false;
    }

    function setModeNeutral() {
      // Al cargar, nada seleccionado aún
      document.getElementById('customPrompt').disabled = false;
      document.getElementById('tipoSelect').disabled = false;
      document.querySelectorAll('input[name="dificultad"]').forEach(r => r.disabled = false);
      const guardarBtn = document.getElementById('guardarBtn');
      if (guardarBtn) guardarBtn.disabled = false;
    }

    // ---------- Carga de datos y wiring ----------
    async function fetchData() {
      const [casos, agentes] = await Promise.all([
        fetch('/api/casos/').then(r => r.json()),
        fetch('/api/agentes/').then(r => r.json())
      ]);

      const categorias = {};
      casos.forEach(c => {
        if (!categorias[c.categoria]) categorias[c.categoria] = [];
        categorias[c.categoria].push(c);
      });

      const categoriaSelect = document.getElementById('categoriaSelect');
      const defaultCatOpt = new Option('Seleccione una opción', '');
      defaultCatOpt.disabled = true;
      defaultCatOpt.selected = true;
      categoriaSelect.add(defaultCatOpt);
      Object.keys(categorias).forEach(cat => categoriaSelect.add(new Option(cat, cat)));

      categoriaSelect.onchange = () => {
        const selected = categoriaSelect.value;
        const casoSelect = document.getElementById('casoSelect');
        casoSelect.innerHTML = '';
        const defaultCasoOpt = new Option('Seleccione una opción', '');
        defaultCasoOpt.disabled = true;
        defaultCasoOpt.selected = true;
        casoSelect.add(defaultCasoOpt);
        casoSelect.disabled = !selected;
        if (selected) {
          categorias[selected].forEach(c => casoSelect.add(new Option(c.titulo, c.id)));
          casoSelect.disabled = false;
        }
      };

      const casoSelect = document.getElementById('casoSelect');
      casoSelect.innerHTML = '';
      const defaultCasoOpt2 = new Option('Seleccione una opción', '');
      defaultCasoOpt2.disabled = true;
      defaultCasoOpt2.selected = true;
      casoSelect.add(defaultCasoOpt2);
      casoSelect.disabled = true;

      const preguntaSelect = document.getElementById('preguntaSelect');
      const promptPreview = document.getElementById('promptPreview');

      casoSelect.onchange = async () => {
        const casoId = casoSelect.value;
        const preguntas = await fetch(`/api/casos/${casoId}/preguntas/`).then(r => r.json());

        preguntaSelect.innerHTML = '';
        const defaultOption = new Option('-- Selecciona un prompt --', '');
        defaultOption.disabled = true;
        defaultOption.selected = true;
        preguntaSelect.add(defaultOption);
        promptPreview.textContent = '';

        preguntas.forEach(p => {
          const preview = p.texto.length > 100
            ? p.texto.slice(0, 90).replace(/(.{30})/g, '$1 ') + '...'
            : p.texto;
          const opt = new Option(preview, p.id);
          opt.title = p.texto;
          opt.dataset.full = p.texto;
          preguntaSelect.add(opt);
        });

        // Al cambiar de caso, volvemos a estado neutral
        setModeNeutral();
      };

      preguntaSelect.addEventListener('change', () => {
        const val = preguntaSelect.value;
        if (val) {
          const full = preguntaSelect.options[preguntaSelect.selectedIndex].dataset.full || '';
          promptPreview.textContent = full;
          setModePredef();
        } else {
          promptPreview.textContent = '';
          setModeNeutral();
        }
      });

      // Activar modo personalizado al enfocar el textarea
      const customPromptElem = document.getElementById('customPrompt');
      customPromptElem.addEventListener('focus', setModeCustom);
      customPromptElem.addEventListener('input', () => {
        if (!customPromptElem.value.trim()) {
          setModeNeutral();
        }
      });

      // Cargar lista de agentes
      const agenteSelect = document.getElementById('agenteSelect');
      agentes.forEach(a => agenteSelect.add(new Option(a.nombre, a.id)));

      // Estado inicial
      setModeNeutral();
    }

    async function runAgent() {
      const runBtn   = document.getElementById('runBtn');
      const agente   = document.getElementById('agenteSelect').value;
      const pregunta = document.getElementById('preguntaSelect').value;
      const custom   = document.getElementById('customPrompt').value;

      if (!custom.trim() && !pregunta) {
        alert("Selecciona un prompt a ejecutar.");
        return;
      }

      const runningModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('runningModal'));

      runBtn.disabled = true;
      runningModal.show();

      try {
        const pregunta_id = pregunta ? pregunta : "0";
        const res = await fetch(`/run/${pregunta_id}/${agente}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
            'Accept': 'application/json'
          },
          body: JSON.stringify({ prompt_manual: custom })
        });

        if (!res.ok) {
          const errBody = await res.text().catch(()=>'');
          throw new Error(`HTTP ${res.status} ${res.statusText} ${errBody}`);
        }

        const data = await res.json();

        // NUEVO FLUJO ASÍNCRONO: el backend devuelve job_id
        if (!data.resultado_id) {
          throw new Error(data.error || 'No se recibió resultado_id');
        }

        // SIEMPRE: espera a que termine consultando /run/status/<resultado_id>/
        const resultadoId = await waitForCompletion(data.resultado_id);

        runningModal.hide();

        // Mostrar modal de éxito y habilitar enlace de evaluación
        const successModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('successModal'));
        successModal.show();

        const evalLink = document.getElementById('evaluarAgenteLink');
        if (evalLink && resultadoId) {
          evalLink.classList.remove('disabled');
          evalLink.href = `/resultados/${resultadoId}/`;
        }
        return;

        // COMPAT: si el backend sigue siendo síncrono y devuelve resultado_id
        if (data.resultado_id) {
          runningModal.hide();
          const successModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('successModal'));
          successModal.show();

          const evalLink = document.getElementById('evaluarAgenteLink');
          if (evalLink) {
            evalLink.classList.remove('disabled');
            evalLink.href = `/resultados/${data.resultado_id}/`;
          }
          return;
        }

        throw new Error(data.error || 'Respuesta inesperada del servidor');

      } catch (err) {
        console.error(err);
        runningModal.hide();
        alert(`Error ejecutando el agente: ${err.message}`);
      } finally {
        runBtn.disabled = false;
      }
    }

    // Polling del estado del job hasta terminar
    async function waitForCompletion(resultadoId) {
      const maxWaitMs = 10 * 60 * 1000; // 10 min
      const start = Date.now();
      let delay = 2000;

      while (Date.now() - start < maxWaitMs) {
        const r = await fetch(`/run/status/${resultadoId}/`, { headers: { 'Accept': 'application/json' }});
        if (!r.ok) throw new Error(`Estado HTTP ${r.status}`);

        const s = await r.json();
        // Backend: status = 'pending' | 'in_progress' | 'completed' | 'error'
        if (s.status === 'completed') {
          return s.resultado_id;
        }
        if (s.status === 'error') {
          throw new Error(s.error || 'El agente falló');
        }

        await new Promise(res => setTimeout(res, delay));
        if (delay < 5000) delay += 500;
      }
      throw new Error('Timeout esperando a que termine el agente');
    }

    async function savePrompt() {
      const casoId     = document.getElementById('casoSelect').value;
      const texto      = document.getElementById('customPrompt').value;
      const tipo       = document.getElementById('tipoSelect').value;
      const dificultad = getSelectedDificultad();

      if (!casoId)      return alert("Selecciona un caso de uso antes de guardar.");
      if (!texto.trim()) return alert("Escribe un prompt personalizado para guardarlo.");
      if (!tipo)        return alert("Selecciona un tipo de tarea.");
      if (!dificultad)  return alert("Selecciona una dificultad.");

      const res = await fetch(`/api/casos/${casoId}/preguntas/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ texto, tipo, dificultad })
      });

      if (res.ok) {
        const nueva = await res.json();
        if (window.confirm("Prompt guardado correctamente.")) {
          const modalEl = document.getElementById('nuevoPromptModal');
          const modal = bootstrap.Modal.getInstance(modalEl);
          modal?.hide(); // Cierra el modal si existe la instancia
        }
        // Limpiar campos del modal
        document.getElementById('customPrompt').value = '';
        document.getElementById('tipoSelect').selectedIndex = 0;
        document.querySelectorAll('input[name="dificultad"]').forEach(r => r.checked = false);
        // Añadir el nuevo prompt al desplegable y resetear selección
        const preguntaSelect = document.getElementById('preguntaSelect');
        preguntaSelect.disabled = false;
        const previewText = nueva.texto.length > 100
          ? nueva.texto.slice(0, 90).replace(/(.{30})/g, '$1 ') + '...'
          : nueva.texto;
        const opt = new Option(previewText, nueva.id);
        opt.title = nueva.texto;
        opt.dataset.full = nueva.texto;
        preguntaSelect.add(opt);
        preguntaSelect.selectedIndex = 0;
        preguntaSelect.dispatchEvent(new Event('change'));
      } else {
        console.error(await res.json().catch(() => ({})));
        alert("Error al guardar el prompt.");
      }
    }

    function abrirModalPrompt() {
      const categoria = document.getElementById('categoriaSelect');
      const caso = document.getElementById('casoSelect');
      if (!categoria.value || !caso.value) {
        alert("Debes seleccionar una categoría y un caso de uso antes de crear un nuevo prompt.");
        return;
      }
      const categoriaTexto = `Categoría: ${categoria.value}`;
      const casoTexto = `Caso de uso: ${caso.options[caso.selectedIndex].text}`;
      document.getElementById('contextoSeleccionado').innerHTML = `
        <p><strong>${categoriaTexto}</strong></p>
        <p><strong>${casoTexto}</strong></p>
      `;
      // Rehabilitar y limpiar campos del modal
      const customPrompt = document.getElementById('customPrompt');
      const tipoSelect = document.getElementById('tipoSelect');
      customPrompt.disabled = false;
      customPrompt.value = '';
      tipoSelect.disabled = false;
      tipoSelect.selectedIndex = 0;
      document.querySelectorAll('input[name="dificultad"]').forEach(r => {
        r.disabled = false;
        r.checked = false;
      });
      // Mostrar el modal de nuevo prompt
      new bootstrap.Modal(document.getElementById('nuevoPromptModal')).show();
    }

    function getSelectedDificultad() {
      const radios = document.querySelectorAll('#dificultadToggle input[type=radio]');
      for (const r of radios) {
        if (r.checked) return r.value;
      }
      return '';
    }

    function getCookie(name) {
      let cookieValue = null;
      document.cookie.split(';').forEach(cookie => {
        const trimmed = cookie.trim();
        if (trimmed.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(trimmed.slice(name.length + 1));
        }
      });
      return cookieValue;
    }

    window.onload = fetchData;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
