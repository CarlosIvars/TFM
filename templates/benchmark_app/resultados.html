<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Resultados del Agente</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 1200px; }
    .panel { background: white; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.05); padding: 20px; }
    pre.resultado-box { max-height: 500px; overflow-y: auto; background-color: #e9ecef; padding: 15px; border-radius: 5px; white-space: pre-wrap; }
    .list-scroll { max-height: 600px; overflow-y: auto; }
    .header {
      background-image: linear-gradient(135deg, #0d6efd, #66b3ff83);
      color: white;
      padding: 30px;
      border-radius: 0.5rem;
      margin-bottom: 30px;
      text-align: center;
    }
    .filter-section-title { font-weight: 600; margin-top: .25rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-4" style="background: linear-gradient(90deg, #0d6efd, #66b2ff); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div class="container d-flex justify-content-between align-items-center">
      <span class="navbar-brand text-white fw-semibold mb-0 h1">Benchmark de Agentes</span>
      <a href="/admin/login/?next=/admin/" class="btn btn-outline-light">Admin</a>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="header">
      <h1 class="h3">Evaluación de Agentes de Web Scraping</h1>
      <p class="mb-0">Selecciona una ejecución y realiza la evaluación.</p>
    </div>

    <!-- Tabs de navegación -->
    <ul class="nav nav-tabs mb-4">
      <li class="nav-item">
        <a class="nav-link" href="/">Ejecutar Agente</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" aria-current="page" href="#">Evaluar Agente</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/metricas/">Métricas Agentes</a>
      </li>
    </ul>

    <h2 class="mb-4">Resultado de la Ejecución</h2>

    <div class="row g-4">
      <!-- Columna izquierda: listado de ejecuciones + filtro -->
      <div class="col-md-3">
        <div class="panel panel-filter">
          <h5 class="mb-3 d-flex justify-content-between align-items-center">
            Ejecuciones
            <div class="dropdown ms-auto">
              <button class="btn btn-sm btn-outline-secondary" id="filterToggle"
                      data-bs-toggle="dropdown" aria-expanded="false" title="Filtrar">
                <i class="bi bi-funnel"></i>
              </button>
              <div class="dropdown-menu dropdown-menu-end p-3"
                  style="width:320px; max-height:260px; overflow:auto;" id="filterMenu">
                <div class="small text-muted">Cargando filtros…</div>
              </div>
            </div>
          </h5>

          <div id="lista-ejecuciones" class="list-group list-scroll">
            <!-- Rellenado por JS desde /api/resultados/ -->
          </div>
        </div>
      </div>

      <!-- Columna central: resultado del agente -->
      <div class="col-md-4">
        <div class="panel">
          {% if ejecucion and ejecucion.pregunta %}
            <h5>Pregunta:</h5>
            <p class="mb-3">{{ ejecucion.pregunta.texto }}</p>
          {% endif %}

          <h5>Respuesta del agente:</h5>
          <pre class="resultado-box">{{ ejecucion.respuesta|default:"Selecciona una ejecución de la izquierda" }}</pre>

          <h6 class="mt-3">Logs:</h6>
          <pre class="resultado-box">{{ ejecucion.logs|default:"" }}</pre>
        </div>
      </div>

      <!-- Columna derecha: formulario de evaluación -->
      <div class="col-md-5">
        <div class="panel">
          <h5>Evaluación del resultado</h5>
          {% if mensaje_exito %}
            <div class="alert alert-success">{{ mensaje_exito }}</div>
          {% endif %}

          {% if ejecucion %}
          <form method="post">
            {% csrf_token %}

            <h6 class="mb-2">¿Ha cumplido los pasos?</h6>
            {% for paso in pasos_esperados %}
              <div class="mb-2">
                <label><strong>{{ forloop.counter }}.</strong> {{ paso }}</label>
                <div>
                  <label class="me-2">
                    <input type="radio" name="paso_{{ forloop.counter0 }}" value="si" required /> Sí
                  </label>
                  <label>
                    <input type="radio" name="paso_{{ forloop.counter0 }}" value="no" required /> No
                  </label>
                </div>
              </div>
            {% endfor %}

            <div class="mb-3 mt-3">
              <label class="form-label d-block">Nivel de satisfacción global del agente:</label>
              <div id="rating" class="mb-2" style="font-size: 2em; cursor: pointer;">
                {% for i in "12345" %}
                  <span class="star" data-value="{{ forloop.counter }}">&#9734;</span>
                {% endfor %}
              </div>
              <input type="hidden" id="nivel_satisfaccion" name="nivel_satisfaccion" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Comentarios adicionales</label>
              <textarea name="comentario" class="form-control" rows="3" placeholder="¿Cómo lo hizo el agente?"></textarea>
            </div>

            <div>
              <button type="submit" class="btn btn-primary w-100 mb-2">Enviar evaluación</button>
              <button type="button" class="btn btn-outline-primary w-100 mt-2"
                      onclick="evaluarLLM()" id="btnEvalLLM" data-resultado-id="{{ ejecucion.id|default:'' }}">
                Evaluación automática (LLM)
              </button>
            </div>
          </form>
          {% else %}
            <div class="alert alert-info">Selecciona una ejecución en la izquierda para evaluar.</div>
          {% endif %}
        </div>

        <div id="evalAutoResultado" class="alert alert-secondary mt-3 d-none"></div>
      </div>
    </div>
  </div>

  <!-- Modal "Ejecutando evaluación LLM" -->
  <div class="modal fade" id="evalRunningModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body d-flex align-items-center gap-3">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <div>
            <h5 class="mb-1">Ejecutando evaluación automática…</h5>
            <small class="text-muted">Por favor, espera</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    function estadoToBadge(estado) {
      switch (estado) {
        case "pending": return "secondary";
        case "in_progress": return "info";
        case "completed": return "success";
        case "error": return "danger";
        default: return "secondary";
      }
    }

    // ===== Globales =====
    let EJECUCIONES_ORIG = [];
    let CATEGORY_MAP = {};      // { categoria: [ {id, titulo, categoria} ] }
    let SELECTED_CASES = new Set(); // ids de casos seleccionados
    let CURRENT_ID = null;

    // ===== Render de la lista según filtros =====
    function renderList() {
      const lista = document.getElementById("lista-ejecuciones");
      lista.innerHTML = "";

      const useFilter = SELECTED_CASES.size > 0;

      const data = EJECUCIONES_ORIG.filter(item => {
        if (!useFilter) return true;
        return item.caso_uso_id && SELECTED_CASES.has(item.caso_uso_id);
      });

      if (data.length === 0) {
        lista.innerHTML = '<div class="text-muted">No hay ejecuciones para los filtros seleccionados.</div>';
        return;
      }

      data.forEach(item => {
        const a = document.createElement("a");
        a.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
        a.href = `/resultados/${item.id}/`;

        a.innerHTML = `
          <div>
            <div><strong>#${item.id}</strong> - ${item.agente_nombre || "Agente"}</div>
            <small class="text-muted">${item.fecha_human || ""}</small>
          </div>
          <span class="badge bg-${estadoToBadge(item.estado)}">${item.estado || '—'}</span>
        `;

        // Tooltip con la pregunta
        const tooltipText = item.pregunta_texto || item.pregunta_preview || "";
        if (tooltipText) {
          a.setAttribute('data-bs-toggle', 'tooltip');
          a.setAttribute('data-bs-placement', 'right');
          a.setAttribute('data-bs-title', tooltipText);
        }

        if (CURRENT_ID && String(item.id) === String(CURRENT_ID)) {
          a.classList.add("active");
        }
        lista.appendChild(a);
      });

      // Inicializar tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
    }

    // ===== Panel de filtros =====
    function buildFilterPanel() {
      const container = document.getElementById("filterMenu");
      if (!container) return;

      let html = "";
      for (const cat of Object.keys(CATEGORY_MAP).sort()) {
        const cases = CATEGORY_MAP[cat];
        const catId = btoa(cat); // id estable para la categoría
        html += `
          <div class="mb-2">
            <div class="form-check">
              <input class="form-check-input cat-checkbox" type="checkbox"
                    id="cat_${catId}" data-category="${cat}" checked>
              <label class="form-check-label fw-semibold" for="cat_${catId}">${cat}</label>
            </div>
        `;
        cases.forEach(caso => {
          html += `
            <div class="form-check ms-4">
              <input class="form-check-input case-checkbox" type="checkbox"
                    id="case_${caso.id}" data-category="${cat}" data-case="${caso.id}" checked>
              <label class="form-check-label" for="case_${caso.id}">${caso.titulo}</label>
            </div>
          `;
          SELECTED_CASES.add(caso.id);
        });
        html += `</div>`;
      }

      if (html.trim() === "") {
        html = '<div class="text-muted small">No hay categorías/casos para filtrar.</div>';
      }

      container.innerHTML = html;

      // Listeners
      container.querySelectorAll(".cat-checkbox").forEach(cb => {
        cb.addEventListener("change", (ev) => {
          const cat = ev.target.dataset.category;
          const checked = ev.target.checked;
          container.querySelectorAll(`.case-checkbox[data-category="${cat}"]`).forEach(caseCb => {
            caseCb.checked = checked;
            const cid = parseInt(caseCb.dataset.case);
            if (checked) SELECTED_CASES.add(cid); else SELECTED_CASES.delete(cid);
          });
          renderList();
        });
      });

      container.querySelectorAll(".case-checkbox").forEach(cb => {
        cb.addEventListener("change", (ev) => {
          const cid = parseInt(ev.target.dataset.case);
          const cat = ev.target.dataset.category;
          if (ev.target.checked) SELECTED_CASES.add(cid); else SELECTED_CASES.delete(cid);

          const allCases = Array.from(container.querySelectorAll(`.case-checkbox[data-category="${cat}"]`));
          const allChecked = allCases.every(el => el.checked);
          const catCb = container.querySelector(`.cat-checkbox[data-category="${cat}"]`);
          if (catCb) catCb.checked = allChecked;

          renderList();
        });
      });
    }

    function setupFilterToggle() {
      const toggle = document.getElementById("filterToggle");
      const panel = document.getElementById("filterPanel");
      if (!toggle || !panel) return;

      toggle.addEventListener("click", (e) => {
        e.stopPropagation();
        panel.style.display = (panel.style.display === "none" || panel.style.display === "") ? "block" : "none";
      });

      document.addEventListener("click", (e) => {
        const within = panel.contains(e.target) || toggle.contains(e.target);
        if (!within) panel.style.display = "none";
      });
    }

    // ===== Carga inicial =====
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        // Detectar ejecución actual desde la URL
        const match = window.location.pathname.match(/\/resultados\/(\d+)\/?/);
        CURRENT_ID = match ? match[1] : null;

        // Cargar ejecuciones
        const res = await fetch("/api/resultados/");
        EJECUCIONES_ORIG = await res.json();

        // Cargar casos (para mapa categoría->casos)
        const resCasos = await fetch("/api/casos/");
        const casos = await resCasos.json();
        CATEGORY_MAP = {};
        (casos || []).forEach(c => {
          if (!CATEGORY_MAP[c.categoria]) CATEGORY_MAP[c.categoria] = [];
          CATEGORY_MAP[c.categoria].push(c);
        });

        // Construir filtro y renderizar lista
        buildFilterPanel();
        renderList();

      } catch (e) {
        console.error(e);
        document.getElementById("lista-ejecuciones").innerHTML = '<div class="text-danger">Error cargando ejecuciones.</div>';
      }

      // Estrellas de rating
      const stars = document.querySelectorAll(".star");
      const input = document.getElementById("nivel_satisfaccion");
      if (stars && input) {
        let currentValue = 0;
        const highlight = (n) => {
          stars.forEach((star, i) => {
            star.innerHTML = i < n ? "★" : "☆";
            star.style.color = i < n ? "#FFD700" : "#555";
          });
        };
        stars.forEach((star, idx) => {
          star.addEventListener("mouseover", () => highlight(idx + 1));
          star.addEventListener("mouseout", () => highlight(currentValue));
          star.addEventListener("click", () => {
            currentValue = idx + 1;
            input.value = currentValue;
            highlight(currentValue);
          });
        });
      }
    });

    // ===== Evaluación automática (LLM) =====
    async function evaluarLLM() {
      const btn = document.getElementById("btnEvalLLM");
      const resultadoId = btn?.dataset?.resultadoId;
      if (!resultadoId) {
        alert("Selecciona una ejecución primero.");
        return;
      }
      const runningModalEl = document.getElementById("evalRunningModal");
      let runningModal = null;
      if (runningModalEl) {
        runningModal = new bootstrap.Modal(runningModalEl);
        runningModal.show();
      }
      try {
        await fetch(`/evaluar_llm/${resultadoId}/`);
        if (runningModal) runningModal.hide();
        alert("Evaluación automática completada.");
        window.location.reload();
      } catch (err) {
        if (runningModal) runningModal.hide();
        console.error(err);
        alert("Error ejecutando la evaluación automática.");
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
