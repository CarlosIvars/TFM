<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resultados del Agente</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 1200px; }
    .panel { background: white; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.05); padding: 20px; }
    pre.resultado-box { max-height: 500px; overflow-y: auto; background-color: #e9ecef; padding: 15px; border-radius: 5px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h2 class="mb-4">Resultado de la Ejecución</h2>
    <div class="row g-4">
      <!-- Columna izquierda: resultado del agente -->
      <div class="col-md-7">
        <div class="panel">
          <h5>Respuesta del agente:</h5>
          <pre class="resultado-box">{{ ejecucion.respuesta }}</pre>

          <h6 class="mt-3">Logs:</h6>
          <pre class="resultado-box">{{ ejecucion.logs }}</pre>
        </div>
      </div>

      <!-- Columna derecha: formulario de evaluación -->
     <div class="col-md-5">
        <div class="panel">
          <h5>Evaluación del resultado</h5>
          {% if mensaje_exito %}
            <div class="alert alert-success">{{ mensaje_exito }}</div>
          {% endif %}
          <form method="post">
            {% csrf_token %}

            <h6 class="mb-2">¿Ha cumplido los pasos?</h6>
            {% for paso in pasos_esperados %}
              <div class="mb-2">
                <label><strong>{{ forloop.counter }}.</strong> {{ paso }}</label>
                <div>
                  <label class="me-2">
                    <input type="radio" name="paso_{{ forloop.counter0 }}" value="si" required> Sí
                  </label>
                  <label>
                    <input type="radio" name="paso_{{ forloop.counter0 }}" value="no" required> No
                  </label>
                </div>
              </div>
            {% endfor %}

            <div class="mb-3 mt-3">
              <label class="form-label d-block">Nivel de satisfacción global del agente:</label>
              <div id="rating" class="mb-2" style="font-size: 2em; cursor: pointer;">
                {% for i in "12345" %}
                  <span class="star" data-value="{{ forloop.counter }}">&#9734;</span>
                {% endfor %}
              </div>
              <input type="hidden" id="nivel_satisfaccion" name="nivel_satisfaccion" required>
            </div>


            <div class="mb-3">
              <label class="form-label">Comentarios adicionales</label>
              <textarea name="comentario" class="form-control" rows="3" placeholder="¿Cómo lo hizo el agente?"></textarea>
            </div>

            <button type="submit" class="btn btn-primary w-100">Enviar evaluación</button>
          </form>
        </div>
      </div>

    </div>
  </div>

<script>
    async function runAgent() {
    const caso = document.getElementById('casoSelect').value;
    const agente = document.getElementById('agenteSelect').value;
    const pregunta = document.getElementById('preguntaSelect').value;
    const customPrompt = document.getElementById('customPrompt').value;

    const res = await fetch(`/run/${caso}/${agente}/`, {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ pregunta_id: pregunta, prompt_manual: customPrompt })
    });

    const data = await res.json();

    if (data.redirect_url) {
        window.location.href = data.redirect_url;
    } else {
        alert("Error: No se pudo ejecutar el agente.");
        console.error(data);
    }
    }

    // Rating stars
    document.addEventListener("DOMContentLoaded", function() {
      const stars = document.querySelectorAll('.star');
      const input = document.getElementById('nivel_satisfaccion');
      let currentValue = 0;

      stars.forEach((star, idx) => {
        star.addEventListener('mouseover', function() {
          highlightStars(idx + 1);
        });
        star.addEventListener('mouseout', function() {
          highlightStars(currentValue);
        });
        star.addEventListener('click', function() {
          currentValue = idx + 1;
          input.value = currentValue;
          highlightStars(currentValue);
        });
      });

      function highlightStars(n) {
        stars.forEach((star, i) => {
          if (i < n) {
            star.innerHTML = '★'; // Filled star
            star.style.color = "#FFD700";
          } else {
            star.innerHTML = '☆'; // Empty star
            star.style.color = "#555";
          }
        });
      }
    });
</script>

</body>
</html>

