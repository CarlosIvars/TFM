<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resultados del Agente</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 1200px; }
    .panel { background: white; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.05); padding: 20px; }
    pre.resultado-box { max-height: 500px; overflow-y: auto; background-color: #e9ecef; padding: 15px; border-radius: 5px; white-space: pre-wrap; }
    .list-scroll { max-height: 600px; overflow-y: auto; }

    /* ⬇️ Igual que en home.html */
    .header {
      background-image: linear-gradient(135deg, #0d6efd, #66b3ff83);
      color: white;
      padding: 30px;
      border-radius: 0.5rem;
      margin-bottom: 30px;
      text-align: center;
    }
  </style>
  
</head>
<body>
   <nav class="navbar navbar-expand-lg mb-4" style="background: linear-gradient(90deg, #0d6efd, #66b2ff); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div class="container d-flex justify-content-between align-items-center">
      <span class="navbar-brand text-white fw-semibold mb-0 h1">Benchmark de Agentes</span>
      <a href="/admin/login/?next=/admin/" class="btn btn-outline-light">Admin</a>
    </div>
  </nav>
  <div class="container mt-4">
    <div class="header">
      <h1 class="h3">Evaluación de Agentes de Web Scraping</h1>
      <p class="mb-0">Selecciona una ejecución y realiza la evaluación.</p>
    </div>
    <!-- Tabs navegación -->
    <ul class="nav nav-tabs mb-4">
      <li class="nav-item">
        <a class="nav-link" href="/">Ejecutar Agente</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" aria-current="page" href="#">Evaluar Agente</a>
      </li>
    </ul>

    <h2 class="mb-4">Resultado de la Ejecución</h2>
    <div class="row g-4">
      <!-- Columna izquierda: listado de ejecuciones -->
      <div class="col-md-3">
        <div class="panel">
          <h5 class="mb-3">Ejecuciones</h5>
          <div id="lista-ejecuciones" class="list-group list-scroll">
            <!-- Rellenado por JS desde /api/resultados/ -->
          </div>
        </div>
      </div>

      <!-- Columna central: resultado del agente (respuesta/logs) -->
      <div class="col-md-4">
        <div class="panel">
          <h5>Respuesta del agente:</h5>
          <pre class="resultado-box">{{ ejecucion.respuesta|default:"Selecciona una ejecución de la izquierda" }}</pre>

          <h6 class="mt-3">Logs:</h6>
          <pre class="resultado-box">{{ ejecucion.logs|default:"" }}</pre>
        </div>
      </div>

      <!-- Columna derecha: formulario de evaluación -->
      <div class="col-md-5">
        <div class="panel">
          <h5>Evaluación del resultado</h5>
          {% if mensaje_exito %}
            <div class="alert alert-success">{{ mensaje_exito }}</div>
          {% endif %}

          {% if ejecucion %}
          <form method="post">
            {% csrf_token %}

            <h6 class="mb-2">¿Ha cumplido los pasos?</h6>
            {% for paso in pasos_esperados %}
              <div class="mb-2">
                <label><strong>{{ forloop.counter }}.</strong> {{ paso }}</label>
                <div>
                  <label class="me-2">
                    <input type="radio" name="paso_{{ forloop.counter0 }}" value="si" required> Sí
                  </label>
                  <label>
                    <input type="radio" name="paso_{{ forloop.counter0 }}" value="no" required> No
                  </label>
                </div>
              </div>
            {% endfor %}

            <div class="mb-3 mt-3">
              <label class="form-label d-block">Nivel de satisfacción global del agente:</label>
              <div id="rating" class="mb-2" style="font-size: 2em; cursor: pointer;">
                {% for i in "12345" %}
                  <span class="star" data-value="{{ forloop.counter }}">&#9734;</span>
                {% endfor %}
              </div>
              <input type="hidden" id="nivel_satisfaccion" name="nivel_satisfaccion" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Comentarios adicionales</label>
              <textarea name="comentario" class="form-control" rows="3" placeholder="¿Cómo lo hizo el agente?"></textarea>
            </div>
            <div>
              <button type="submit" class="btn btn-primary w-100 mb-2">Enviar evaluación</button>
              <button type="button" class="btn btn-outline-primary w-100 mt-2" onclick="evaluarLLM()" id="btnEvalLLM" data-resultado-id="{{ ejecucion.id|default:'' }}">
                Evaluación automática (LLM)
              </button>
            </div>
          </form>
          {% else %}
            <div class="alert alert-info">Selecciona una ejecución en la izquierda para evaluar.</div>
          {% endif %}
        </div>
        <div id="evalAutoResultado" class="alert alert-secondary mt-3 d-none"></div>

      </div>
    </div>
  </div>
  <!-- Modal mientras ejecuta evaluación LLM -->
  <div class="modal fade" id="evalRunningModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body d-flex align-items-center gap-3">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <div>
            <h5 class="mb-1">Ejecutando evaluación automática…</h5>
            <small class="text-muted">Por favor, espera</small>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Carga de todas las ejecuciones en la columna izquierda
    document.addEventListener("DOMContentLoaded", async function() {
      try {
        const res = await fetch('/api/resultados/');
        const data = await res.json();
        const cont = document.getElementById('lista-ejecuciones');
        cont.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) {
          cont.innerHTML = '<div class="text-muted">No hay ejecuciones todavía.</div>';
          return;
        }

        // Si la página está en /resultados/<id>/, resaltar esa ejecución
        const pathMatch = window.location.pathname.match(/\/resultados\/(\d+)\/?/);
        const currentId = pathMatch ? pathMatch[1] : null;

        data.forEach(item => {
          const a = document.createElement('a');
          a.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
          a.href = `/resultados/${item.id}/`;
          a.innerHTML = `
            <div>
              <div><strong>#${item.id}</strong> - ${item.agente_nombre || 'Agente'} </div>
              <small class="text-muted">${item.fecha_human || ''}</small>
            </div>
            <span class="badge bg-${estadoToBadge(item.estado)}">${item.estado || '—'}</span>
          `;
          if (currentId && String(item.id) === String(currentId)) {
            a.classList.add('active');
          }
          cont.appendChild(a);
        });
      } catch (e) {
        console.error(e);
        document.getElementById('lista-ejecuciones').innerHTML = '<div class="text-danger">Error cargando ejecuciones.</div>';
      }

      // Estrellas de rating
      const stars = document.querySelectorAll('.star');
      const input = document.getElementById('nivel_satisfaccion');
      if (stars && input) {
        let currentValue = 0;
        const highlight = (n) => {
          stars.forEach((star, i) => {
            if (i < n) { star.innerHTML = '★'; star.style.color = "#FFD700"; }
            else { star.innerHTML = '☆'; star.style.color = "#555"; }
          });
        };
        stars.forEach((star, idx) => {
          star.addEventListener('mouseover', () => highlight(idx + 1));
          star.addEventListener('mouseout', () => highlight(currentValue));
          star.addEventListener('click', () => { currentValue = idx + 1; input.value = currentValue; highlight(currentValue); });
        });
      }
    });

    function estadoToBadge(estado) {
      switch (estado) {
        case 'pending': return 'secondary';
        case 'in_progress': return 'info';
        case 'completed': return 'success';
        case 'error': return 'danger';
        default: return 'secondary';
      }
    }

  // Lanza la evaluación automática LLM para la ejecución actual
    async function evaluarLLM() {
    const btn = document.getElementById('btnEvalLLM');
    const resultadoId = btn?.dataset?.resultadoId;

    if (!resultadoId) {
      alert('Selecciona una ejecución primero.');
      return;
    }

    // Si tienes el modal de “Ejecutando evaluación…”
    const running = document.getElementById('evalRunningModal');
    let runningModal = null;
    if (running) {
      runningModal = new bootstrap.Modal(running);
      runningModal.show();
    }

    try {
      const res = await fetch(`/evaluar_llm/${resultadoId}/`, { method: 'GET' });
      const text = await res.text();

      if (runningModal) runningModal.hide();
      alert('Evaluación automática completada.');
      // Si quieres refrescar:
      window.location.reload();
      // O mostrar 'text' en un panel si prefieres no recargar
    } catch (err) {
      if (runningModal) runningModal.hide();
      console.error(err);
      alert('Error ejecutando la evaluación automática.');
    }
  }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
